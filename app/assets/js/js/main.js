// Generated by CoffeeScript 1.4.0
(function() {

  window.setTemplate = function(url, callback) {
    $('div#actionResult').empty();
    $('div#actionResult').css('display', 'none');
    return $.get(url, function(template) {
      $('div#content').empty().html(template);
      return callback != null ? callback.call(this) : void 0;
    });
  };

  window.updateSessionViews = function(username) {
    $('.loggedout').css('display', username !== "" ? 'none' : 'block');
    return $('.loggedin').css('display', username !== "" ? 'block' : 'none').find('#username').text(username);
  };

  window.setSessionUser = function(user) {
    return requirejs(['/assets/js/account/models/user_model.js'], function() {
      Account.session = new Account.User(user);
      return updateSessionViews(Account.session.get('name'));
    });
  };

  $(function() {
    var sessionRequest;
    window.umappin || (window.umappin = {});
    sessionRequest = $.get("/sessionuser?" + (new Date().getTime()));
    sessionRequest.done(function(data) {
      var profileImg, unreadDiscussions,
        _this = this;
      unreadDiscussions = $.get("/discussions/unread");
      unreadDiscussions.done(function(unread) {
        if (unread !== 'No discussion found') {
          $("#messages-badge").show();
          $("#messages-badge").text(unread.length);
          $("#message-unread").attr("href", "./#messages/message/" + unread.pop().id);
          return sessionStorage.setItem('unread-discusion', JSON.stringify(unread));
        }
      });
      setInterval(function() {
        unreadDiscussions = $.get("/discussions/unread");
        return unreadDiscussions.done(function(unread) {
          if (unread !== 'No discussion found') {
            $("#messages-badge").show();
            $("#messages-badge").text(unread.length);
            $("#message-unread").attr("href", "./#messages/message/" + unread.pop().id);
            return sessionStorage.setItem('unread-discusion', JSON.stringify(unread));
          }
        });
      }, 10000);
      if (data.profilePicture) {
        profileImg = './photos/' + data.profilePicture + '/content';
      } else {
        profileImg = './assets/img/140x140.gif';
      }
      sessionStorage.setItem("user", JSON.stringify(data));
      setSessionUser(data);
      return setTemplate("/assets/templates/main_logged.html", function() {
        $('#profile-picture').html('<img id="my-avatar" src="' + profileImg + '" onload="resize(this)">');
        return requirejs(['/assets/js/router.js'], function() {
          umappin.router || (umappin.router = new umappin.Router);
          Backbone.history.start();
          return this.navigate('#wall/news');
        });
      });
    });
    return sessionRequest.error(function() {
      updateSessionViews("");
      return setTemplate("/assets/templates/main.html");
    });
  });

}).call(this);
